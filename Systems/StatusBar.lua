---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by hatsu.
--- DateTime: 05.02.2024 15:55
---
do

    local StatusBarData
    local StatusBarButtons
    local MAX_STATUSES = 25


    ---@param button_type number
    ---@param texture string
    ---@param size_x real
    ---@param size_y real
    ---@param relative_frame framehandle
    ---@param frame_point_from framepointtype
    ---@param frame_point_to framepointtype
    ---@param offset_x real
    ---@param offset_y real
    ---@param parent_frame framehandle
    local function NewButton(texture, size_x, size_y, relative_frame, frame_point_from, frame_point_to, offset_x, offset_y, parent_frame)
        local new_Frame = BlzCreateFrame('ScriptDialogButton', parent_frame, 0, 0)
        local new_FrameImage = BlzCreateFrameByType("BACKDROP", "Icon", new_Frame, "", 0)
        local new_FrameCharges = BlzCreateFrameByType("BACKDROP", "ButtonCharges", new_Frame, "", 0)
        local new_FrameChargesText = BlzCreateFrameByType("TEXT", "ButtonChargesText", new_FrameCharges, "", 0)
        local new_FrameBorder = BlzCreateFrameByType("BACKDROP", "Border", new_Frame, "", 0)
        local new_FrameChargesBorder = BlzCreateFrameByType("BACKDROP", "Border", new_FrameCharges, "", 0)
        local new_FrameBar = BlzCreateSimpleFrame("MyBarEx", new_Frame, 0)
        local new_FrameBarText = BlzGetFrameByName("MyBarExText", 0)
        local new_FrameStatusBorder = BlzCreateFrameByType("BACKDROP", "Border", new_Frame, "", 0)

        ButtonList[new_Frame] = {
            status = nil,
            button = new_Frame,
            image = new_FrameImage,
            charges_frame = new_FrameCharges,
            charges_text_frame = new_FrameChargesText,
            bar = new_FrameBar,
            bar_text = new_FrameBarText,
            status_border = new_FrameStatusBorder
        }

        BlzFrameSetScale(new_FrameBarText, 0.9)

        BlzFrameSetEnable(new_Frame, false)
        BlzFrameSetPoint(new_Frame, frame_point_from, relative_frame, frame_point_to, offset_x, offset_y)
        BlzFrameSetSize(new_Frame, size_x, size_y)
        BlzFrameSetTexture(new_FrameImage, texture, 0, true)
        BlzFrameSetAllPoints(new_FrameImage, new_Frame)

        BlzFrameSetPoint(new_FrameCharges, FRAMEPOINT_TOPRIGHT, new_FrameImage, FRAMEPOINT_BOTTOMRIGHT, 0.,0.)
        BlzFrameSetPoint(new_FrameCharges, FRAMEPOINT_TOPLEFT, new_FrameImage, FRAMEPOINT_BOTTOMLEFT, 0.,0.)
        BlzFrameSetSize(new_FrameCharges, 0.008, 0.008)
        BlzFrameSetTexture(new_FrameCharges, "GUI\\ChargesTexture.blp", 0, true)
        BlzFrameSetPoint(new_FrameChargesText, FRAMEPOINT_CENTER, new_FrameCharges, FRAMEPOINT_CENTER, 0.,0.)
        BlzFrameSetText(new_FrameChargesText, "")
        BlzFrameSetScale(new_FrameChargesText, 0.85)

        BlzFrameSetVisible(new_FrameCharges, false)

        BlzFrameSetSize(new_FrameBorder, 1., 1.)
        BlzFrameSetTexture(new_FrameBorder, "UI\\inventory_frame.blp", 0, true)
        BlzFrameSetAllPoints(new_FrameBorder, new_Frame)

        BlzFrameSetSize(new_FrameChargesBorder, 1., 1.)
        BlzFrameSetTexture(new_FrameChargesBorder, "UI\\inventory_frame.blp", 0, true)
        BlzFrameSetAllPoints(new_FrameChargesBorder, new_FrameCharges)

        BlzFrameSetPoint(new_FrameBar, FRAMEPOINT_BOTTOMLEFT, new_Frame, FRAMEPOINT_TOPLEFT, 0.,0.)
        BlzFrameSetPoint(new_FrameBar, FRAMEPOINT_BOTTOMRIGHT, new_Frame, FRAMEPOINT_TOPRIGHT, 0.,0.)
        BlzFrameSetSize(new_FrameBar, 0.038, 0.005)
        BlzFrameSetText(new_FrameBarText, "")
        BlzFrameSetTexture(new_FrameBar, "Replaceabletextures\\Teamcolor\\Teamcolor22.blp", 0, true)

        BlzFrameSetSize(new_FrameStatusBorder, 1., 1.)
        BlzFrameSetTexture(new_FrameStatusBorder, "UI\\RedHighlightUI.blp", 0, true)
        BlzFrameSetAllPoints(new_FrameStatusBorder, new_Frame)

        BlzFrameSetVisible(new_Frame, false)
        BlzFrameSetVisible(new_FrameBar, false)

        return new_Frame
    end



    local function ReplaceSlot(from, to, player)
        local button = GetButtonData(StatusBarButtons[player][from])
        local target_Button = GetButtonData(StatusBarButtons[player][to])

            StatusBarData[player][to] = MergeTables({}, StatusBarData[player][from])
            BlzFrameSetValue(target_Button.bar, BlzFrameGetValue(button.bar))

        --[[
            if StringLength(BlzFrameGetText(button.charges_text_frame)) > 0 then
                BlzFrameSetVisible(target_Button.charges_frame, true)
                BlzFrameSetText(target_Button.charges_text_frame, BlzFrameGetText(button.charges_text_frame))

                local length = StringLength(BlzFrameGetText(button.charges_text_frame))

                if length >= 3 then BlzFrameSetScale(target_Button.charges_text_frame, 0.65)
                elseif length >= 2 then BlzFrameSetScale(target_Button.charges_text_frame, 0.75)
                else BlzFrameSetScale(target_Button.charges_text_frame, 0.85) end

            end

            if StatusBarData[player][to].time then
                if GetLocalPlayer() == Player(player - 1) then BlzFrameSetVisible(target_Button.bar, true) end
                BlzFrameSetMinMaxValue(target_Button.bar, 0, StatusBarData[player][to].time)
            end

            BlzFrameSetVisible(target_Button.status_border, StatusBarData[player][to].polarity == NEGATIVE_BUFF)]]
            UpdateStatusBarState(to, player)
    end


    ---@param index integer
    ---@param player integer
    function UpdateStatusBarState(index, player)
        if player > 6 then return end
        local button = GetButtonData(StatusBarButtons[player][index])

            if StatusBarData[player][index] then

                BlzFrameSetTexture(button.image, StatusBarData[player][index].icon, 0, true)
                if GetLocalPlayer() == Player(player - 1) then BlzFrameSetVisible(StatusBarButtons[player][index], true) end


                if StatusBarData[player][index].time then
                    if GetLocalPlayer() == Player(player - 1) then BlzFrameSetVisible(button.bar, true) end
                    BlzFrameSetMinMaxValue(button.bar, 0, StatusBarData[player][index].time)
                end

                if StatusBarData[player][index].value and StatusBarData[player][index].value > 0 then
                    BlzFrameSetVisible(button.charges_frame, true)
                    BlzFrameSetText(button.charges_text_frame, I2S(math.floor(StatusBarData[player][index].value + 0.5)))
                    if StatusBarData[player][index].value >= 100 then BlzFrameSetScale(button.charges_text_frame, 0.65)
                    elseif StatusBarData[player][index].value >= 10 then BlzFrameSetScale(button.charges_text_frame, 0.75)
                    else BlzFrameSetScale(button.charges_text_frame, 0.85) end
                end

                BlzFrameSetVisible(button.status_border, StatusBarData[player][index].polarity == NEGATIVE_BUFF)
            else
                BlzFrameSetTexture(button.image, "ReplaceableTextures\\CommandButtons\\BTNPeon.blp", 0, true)
                if GetLocalPlayer() == Player(player - 1) then BlzFrameSetVisible(StatusBarButtons[player][index], false); BlzFrameSetVisible(button.bar, false) end
                BlzFrameSetVisible(button.charges_frame, false)
                BlzFrameSetText(button.charges_text_frame, "")

                local last_empty_slot = index

                    for i = index+1, MAX_STATUSES do
                        if StatusBarData[player][i] then
                            ReplaceSlot(i, last_empty_slot, player)
                            --UpdateStatusBarState(last_empty_slot, player)
                            StatusBarData[player][i] = nil
                            UpdateStatusBarState(i, player)
                            break
                        end
                    end

            end

    end


    ---@param id string
    ---@param value real
    ---@param player integer
    function UpdateStatusBarTime(id, value, player)
        if player > 6 then return end

            for i = 1, MAX_STATUSES do
                if StatusBarData[player][i] and StatusBarData[player][i].id == id then
                    local button = GetButtonData(StatusBarButtons[player][i])

                        BlzFrameSetValue(button.bar, value)
                        BlzFrameSetText(button.bar_text, I2S(math.floor(value  + 0.5)))

                    break
                end
            end

    end


    ---@param id string
    ---@param time real
    ---@param player integer
    function SetStatusBarTime(id, time, player)
        if player > 6 then return end

            for i = 1, MAX_STATUSES do
                if StatusBarData[player][i] and StatusBarData[player][i].id == id then
                    local button = GetButtonData(StatusBarButtons[player][i])

                        StatusBarData[player][i].time = time
                        BlzFrameSetMinMaxValue(button.bar, 0, time)
                        BlzFrameSetText(button.bar_text, I2S(math.floor(time  + 0.5)))
                        if GetLocalPlayer() == Player(player - 1) then BlzFrameSetVisible(button.bar, true) end
                end
            end

    end


    ---@param id string
    ---@param value real
    ---@param player integer
    function SetStatusBarValue(id, value, player)
        if player > 6 then return end

            for i = 1, MAX_STATUSES do
                if StatusBarData[player][i] and StatusBarData[player][i].id == id then
                    local button = GetButtonData(StatusBarButtons[player][i])

                        BlzFrameSetText(button.charges_text_frame, I2S(math.floor(value  + 0.5)))
                        BlzFrameSetVisible(button.charges_frame, true)
                        StatusBarData[player][i].value = value
                end

            end

    end


    ---@param id string
    ---@param player integer
    function RemoveStatusBarState(id, player)

        if player > 6 then return end

        for i = 1, MAX_STATUSES do
            if StatusBarData[player][i] and StatusBarData[player][i].id == id then
                StatusBarData[player][i] = nil
                UpdateStatusBarState(i, player)
                break
            end
        end

    end


    ---@param id string
    ---@param icon string
    ---@param polarity integer
    ---@param player integer
    function AddStatusBarState(id, icon, polarity, player)

        if player > 6 then return end

        for i = 1, MAX_STATUSES do
            if StatusBarData[player][i] and StatusBarData[player][i].id == id then
                return
            end
        end

        local c = #StatusBarData[player]
        local slot = c + 1

        if slot > MAX_STATUSES then
            return
        end

            if polarity == POSITIVE_BUFF then

                    if StatusBarData[player][c] and StatusBarData[player][c].polarity == NEGATIVE_BUFF then
                        slot = c
                        for i = slot, 1, -1 do
                            if StatusBarData[player][i] and StatusBarData[player][i].polarity == NEGATIVE_BUFF then
                                ReplaceSlot(i, i+1, player)
                                --UpdateStatusBarState(i+1, player)
                            else
                                break
                            end
                        end
                    end

            end


        StatusBarData[player][slot] = { id = id, icon = icon or "ReplaceableTextures\\CommandButtons\\BTNPeon.blp", polarity = polarity }
        UpdateStatusBarState(slot, player)


    end


    
    function DrawStatusBar()
        for player = 1, 6 do

            for i = 1, MAX_STATUSES do
                StatusBarButtons[player][i] = NewButton("ReplaceableTextures\\CommandButtons\\BTNPeon.blp", 0.019, 0.019, GAME_UI, FRAMEPOINT_CENTER, FRAMEPOINT_CENTER, 0., 0., GAME_UI)
            end

            BlzFrameClearAllPoints(StatusBarButtons[player][1])
            BlzFrameSetPoint(StatusBarButtons[player][1], FRAMEPOINT_BOTTOM, GlobalButton[player].char_panel_button, FRAMEPOINT_TOP, -0.018, 0.06)
            BlzFrameSetVisible(StatusBarButtons[player][1], false)

            for i = 2, MAX_STATUSES do
                BlzFrameClearAllPoints(StatusBarButtons[player][i])
                BlzFrameSetPoint(StatusBarButtons[player][i], FRAMEPOINT_LEFT, StatusBarButtons[player][i-1], FRAMEPOINT_RIGHT, 0.001, 0.)
                BlzFrameSetVisible(StatusBarButtons[player][i], false)
            end

        end
    end


    function ReloadStatusBar()
        DrawStatusBar()

            for player = 1, 6 do
                for i = 1, MAX_STATUSES do
                    if StatusBarData[player][i] then
                        UpdateStatusBarState(i, player)
                    end
                end
            end

    end


    function InitStatusBar()

        StatusBarData = {}
        StatusBarButtons = {}


        for i = 1, 6 do
            StatusBarData[i] = { }
            StatusBarButtons[i] = {}
        end

        DrawStatusBar()
    end


end