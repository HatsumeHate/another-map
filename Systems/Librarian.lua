---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by MSI.
--- DateTime: 02.07.2021 17:26
---
do

    LibrarianFrame = 0
    local EXCHANGE_COST = 300
    local QUALITY_PENALTY_COST = 200
    local CATEGORY_PENALTY_COST = 200


    local function RemovePlayerItems(player)
        local button_data = GetButtonData(LibrarianFrame[player].exchange_item_slot)

        if button_data.item then
            button_data.item = nil


        end

    end


    local ClickTrigger = 0
    local EnterTrigger = 0
    local LeaveTrigger = 0


    local function CreateTextBox(player, size_x, size_y, scale, relative_frame, from, to, offset_x, offset_y, owning_frame)
        local new_frame = BlzCreateFrame('ScoreScreenButtonBackdropTemplate', owning_frame, 0, 0)
            BlzFrameSetPoint(new_frame, from, relative_frame, to, offset_x, offset_y)
            BlzFrameSetSize(new_frame, size_x, size_y)

            LibrarianFrame[player].exchange_frame = BlzCreateFrameByType("TEXT", "text", new_frame, "", 0)
            BlzFrameSetPoint(LibrarianFrame[player].exchange_frame, FRAMEPOINT_LEFT, new_frame, FRAMEPOINT_LEFT, 0.01, 0.)
            BlzFrameSetSize(LibrarianFrame[player].exchange_frame, 0.08, 0.03)
            BlzFrameSetText(LibrarianFrame[player].exchange_frame , "")
            BlzFrameSetTextAlignment(LibrarianFrame[player].exchange_frame, TEXT_JUSTIFY_MIDDLE , TEXT_JUSTIFY_LEFT )
            BlzFrameSetScale(LibrarianFrame[player].exchange_frame, scale)
        return new_frame
    end


    ---@param button_type number
    ---@param texture string
    ---@param size_x real
    ---@param size_y real
    ---@param relative_frame framehandle
    ---@param frame_point_from framepointtype
    ---@param frame_point_to framepointtype
    ---@param offset_x real
    ---@param offset_y real
    ---@param parent_frame framehandle
    local function NewButton(button_type, texture, size_x, size_y, relative_frame, frame_point_from, frame_point_to, offset_x, offset_y, parent_frame)
        local new_Frame = BlzCreateFrame('ScriptDialogButton', parent_frame, 0, 0)
        local new_FrameImage = BlzCreateFrameByType("BACKDROP", "ButtonIcon", new_Frame, "", 0)

        ButtonList[new_Frame] = {
            button_type = button_type,
            item = nil,
            button = new_Frame,
            image = new_FrameImage
        }

        FrameRegisterNoFocus(new_Frame)
        FrameRegisterClick(new_Frame, texture)

        BlzTriggerRegisterFrameEvent(ClickTrigger, new_Frame, FRAMEEVENT_CONTROL_CLICK)
        BlzTriggerRegisterFrameEvent(EnterTrigger, new_Frame, FRAMEEVENT_MOUSE_ENTER)
        BlzTriggerRegisterFrameEvent(LeaveTrigger, new_Frame, FRAMEEVENT_MOUSE_LEAVE)

        if button_type == 0 then
            local sprite = CreateSpriteNoCollision("UI\\vampirism_sprite.mdx", 0.74, new_Frame, FRAMEPOINT_BOTTOMLEFT, FRAMEPOINT_BOTTOMLEFT, -0.0048, -0.0048, new_Frame)
        elseif button_type == 2 then
            local new_FrameBorder = BlzCreateFrameByType("BACKDROP", "ButtonBorder", new_FrameImage, "", 0)

                BlzFrameSetTexture(new_FrameBorder, "DiabolicUI_Button_50x50_BorderHighlight.tga", 0, true)
                BlzFrameSetPoint(new_FrameBorder, FRAMEPOINT_TOPRIGHT, new_Frame, FRAMEPOINT_TOPRIGHT, 0.0074, 0.0074)
                BlzFrameSetPoint(new_FrameBorder, FRAMEPOINT_BOTTOMLEFT, new_Frame, FRAMEPOINT_BOTTOMLEFT, -0.0074, -0.0074)

            local sprite = CreateSpriteNoCollision("selecter5.MDX", 1., new_Frame, FRAMEPOINT_BOTTOMLEFT, FRAMEPOINT_BOTTOMLEFT, 0.02, 0.02, new_Frame)
            ButtonList[new_Frame].sprite = sprite
            BlzFrameSetVisible(sprite, false)
        end

        BlzFrameSetPoint(new_Frame, frame_point_from, relative_frame, frame_point_to, offset_x, offset_y)
        BlzFrameSetSize(new_Frame, size_x, size_y)
        BlzFrameSetTexture(new_FrameImage, texture, 0, true)
        BlzFrameSetAllPoints(new_FrameImage, new_Frame)

        return new_Frame
    end



    ---@param text string
    ---@param size_x real
    ---@param size_y real
    ---@param relative_frame framehandle
    ---@param frame_point_from framepointtype
    ---@param frame_point_to framepointtype
    ---@param offset_x real
    ---@param offset_y real
    ---@param parent_frame framehandle
    local function NewSpecialButton(text, size_x, size_y, relative_frame, frame_point_from, frame_point_to, offset_x, offset_y, parent_frame)
        local frame = BlzCreateFrame('ScriptDialogButton', parent_frame, 0, 0)
        local textframe = BlzGetFrameByName("ScriptDialogButtonText", 0)

            BlzFrameSetText(textframe, text)
            BlzFrameSetScale(textframe, 0.8)
            BlzFrameSetTextAlignment(textframe, TEXT_JUSTIFY_CENTER , TEXT_JUSTIFY_MIDDLE)

            BlzFrameSetPoint(frame, frame_point_from, relative_frame, frame_point_to, offset_x, offset_y)
            BlzFrameSetSize(frame, size_x, size_y)

            FrameRegisterNoFocus(frame)

            BlzTriggerRegisterFrameEvent(ClickTrigger, frame, FRAMEEVENT_CONTROL_CLICK)

            ButtonList[frame] = {
                button = frame,
                button_type = 1
            }

        return frame
    end


    function UpdateLibrarianWindow(player)

        if LibrarianFrame[player].state then
            local button = GetButtonData(LibrarianFrame[player].exchange_item_slot)

                if button.item then
                    local total_cost = EXCHANGE_COST
                    local item_data = GetItemData(button.item)

                    if item_data.QUALITY == RARE_ITEM then
                        total_cost = total_cost + QUALITY_PENALTY_COST
                    end

                    local category_button = GetButtonData(LibrarianFrame[player].categories[LibrarianFrame[player].last_category])

                    if category_button.category then
                        total_cost = total_cost + CATEGORY_PENALTY_COST
                    end

                    LibrarianFrame[player].exchange_cost = total_cost

                    BlzFrameSetText(LibrarianFrame[player].exchange_frame, "|c00FFFF00" .. total_cost .. "|r")
                else
                    BlzFrameSetTexture(button.image, "GUI\\inventory_slot.blp", 0, true)
                    BlzFrameSetText(LibrarianFrame[player].exchange_frame, "")
                    LibrarianFrame[player].exchange_cost = 0
                end

            button = GetButtonData(LibrarianFrame[player].categories[LibrarianFrame[player].last_category])
            BlzFrameSetVisible(button.sprite, true)
        end

    end


    ---@param player number
    ---@param item item
    ---@param where number
    function GiveItemToLibrarian(player, item)
        local button = GetButtonData(LibrarianFrame[player].exchange_item_slot)
        local item_data = GetItemData(item)

            button.item = item
            BlzFrameSetTexture(button.image, item_data.frame_texture, 0, true)
            BlzFrameSetAlpha(button.image, 255)
            BlzFrameSetAlpha(button.button, 255)
            UpdateLibrarianWindow(player)

    end


    function ReloadLibrarianFrames()
        for player = 1, 6 do
            if PlayerHero[player] then
                local new_Frame
                local main_frame = BlzCreateFrame('EscMenuBackdrop', GAME_UI, 0, 0)

                    BlzFrameSetPoint(main_frame, FRAMEPOINT_TOPLEFT, GAME_UI, FRAMEPOINT_TOPLEFT, 0.01, -0.05)
                    BlzFrameSetSize(main_frame, 0.3, 0.22)


                    new_Frame = BlzCreateFrameByType('BACKDROP', "PORTRAIT", main_frame, "",0)
                    BlzFrameSetPoint(new_Frame, FRAMEPOINT_TOPLEFT, main_frame, FRAMEPOINT_TOPLEFT, 0.02, -0.02)
                    BlzFrameSetSize(new_Frame, 0.0435, 0.0435)
                    LibrarianFrame[player].portrait = new_Frame

                    new_Frame = BlzCreateFrameByType("TEXT", "shop name", LibrarianFrame[player].portrait, "", 0)
                    BlzFrameSetPoint(new_Frame, FRAMEPOINT_LEFT, LibrarianFrame[player].portrait, FRAMEPOINT_RIGHT, 0.011, 0.)
                    BlzFrameSetTextAlignment(new_Frame, TEXT_JUSTIFY_MIDDLE, TEXT_JUSTIFY_LEFT)
                    BlzFrameSetScale(new_Frame, 1.35)
                    LibrarianFrame[player].name = new_Frame

                    -- from
                    LibrarianFrame[player].categories_border = BlzCreateFrame('EscMenuBackdrop', main_frame, 0, 0)
                    BlzFrameSetPoint(LibrarianFrame[player].categories_border, FRAMEPOINT_BOTTOMLEFT, main_frame, FRAMEPOINT_BOTTOMLEFT, 0.015, 0.015)
                    BlzFrameSetPoint(LibrarianFrame[player].categories_border, FRAMEPOINT_BOTTOMRIGHT, main_frame, FRAMEPOINT_BOTTOMRIGHT, -0.015, -0.015)
                    BlzFrameSetSize(LibrarianFrame[player].categories_border, 0.1, 0.07)


                    LibrarianFrame[player].categories[1] = NewButton(2, "GUI\\inventory_slot.blp", 0.04, 0.04, LibrarianFrame[player].categories_border, FRAMEPOINT_BOTTOMLEFT, FRAMEPOINT_BOTTOMLEFT, 0.015, 0.015, LibrarianFrame[player].categories_border)
                    for i = 2, 5 do
                        LibrarianFrame[player].categories[i] = NewButton(2, "GUI\\inventory_slot.blp", 0.04, 0.04, LibrarianFrame[player].categories[i-1], FRAMEPOINT_LEFT, FRAMEPOINT_RIGHT, 0.01, 0., LibrarianFrame[player].categories_border)
                    end

                    --LibrarianFrame[player].last_category = 1

                    local button_data = GetButtonData(LibrarianFrame[player].categories[1])
                    BlzFrameSetTexture(button_data.image, "ReplaceableTextures\\CommandButtons\\BTNSelectHeroOn.blp", 0, true)
                    FrameChangeTexture(button_data.button, "ReplaceableTextures\\CommandButtons\\BTNSelectHeroOn.blp")

                    new_Frame = BlzCreateFrame('EscMenuBackdrop', main_frame, 0, 0)
                    BlzFrameSetPoint(new_Frame, FRAMEPOINT_BOTTOMLEFT, LibrarianFrame[player].categories_border, FRAMEPOINT_TOPLEFT, 0., 0.)
                    BlzFrameSetPoint(new_Frame, FRAMEPOINT_BOTTOMRIGHT, LibrarianFrame[player].categories_border, FRAMEPOINT_TOPRIGHT, 0., 0.)
                    BlzFrameSetSize(new_Frame, 0.1, 0.07)
                    LibrarianFrame[player].inner_exchange_border = new_Frame
                    -- to

                    new_Frame = BlzCreateFrame('EscMenuBackdrop', LibrarianFrame[player].inner_exchange_border, 0, 0)
                    LibrarianFrame[player].exchange_item_slot = NewButton(0, "GUI\\inventory_slot.blp", 0.04, 0.04, LibrarianFrame[player].inner_exchange_border, FRAMEPOINT_TOPLEFT, FRAMEPOINT_TOPLEFT, 0.015, -0.015, LibrarianFrame[player].inner_exchange_border)
                    BlzFrameSetPoint(new_Frame, FRAMEPOINT_BOTTOMLEFT, LibrarianFrame[player].exchange_item_slot, FRAMEPOINT_BOTTOMLEFT, -0.015, -0.015)
                    BlzFrameSetPoint(new_Frame, FRAMEPOINT_TOPRIGHT, LibrarianFrame[player].exchange_item_slot, FRAMEPOINT_TOPRIGHT, 0.015, 0.015)

                    LibrarianFrame[player].exchange_button = NewSpecialButton(LOCALE_LIST[my_locale].EXCHANGE_BUTTON_TEXT, 0.06, 0.04, LibrarianFrame[player].exchange_item_slot, FRAMEPOINT_LEFT, FRAMEPOINT_RIGHT, 0.025, 0., LibrarianFrame[player].inner_exchange_border)
                    new_Frame = CreateTextBox(player, 0.085, 0.03, 1., LibrarianFrame[player].exchange_button, FRAMEPOINT_LEFT, FRAMEPOINT_RIGHT, 0.0015, 0., main_frame)
                    CreateTooltip(LOCALE_LIST[my_locale].UI_TOOLTIP_EXCHANGE_TITLE, LOCALE_LIST[my_locale].UI_TOOLTIP_EXCHANGE_DESC, LibrarianFrame[player].exchange_button, 0.125, 0.06)
                    LibrarianFrame[player].masterframe = BlzCreateFrameByType("BACKDROP", "ButtonIcon", new_Frame, "", 0)


                    LibrarianFrame[player].tooltip = NewTooltip(LibrarianFrame[player].masterframe)

                    LibrarianFrame[player].main_frame = main_frame
                    BlzFrameSetVisible(LibrarianFrame[player].main_frame, false)
                    LibrarianFrame[player].state = false


                    BlzFrameSetTexture(LibrarianFrame[player].portrait, "ReplaceableTextures\\CommandButtons\\BTNNightElfRunner.blp", 0, true)
                    BlzFrameSetText(LibrarianFrame[player].name, GetUnitName(gg_unit_n01V_0110))
            end
        end
    end


    ---@param player number
    function DrawLibrarianFrames(player)
        local new_Frame
        local main_frame = BlzCreateFrame('EscMenuBackdrop', GAME_UI, 0, 0)


            LibrarianFrame[player] = {}
            BlzFrameSetPoint(main_frame, FRAMEPOINT_TOPLEFT, GAME_UI, FRAMEPOINT_TOPLEFT, 0.01, -0.05)
            BlzFrameSetSize(main_frame, 0.3, 0.22)

            new_Frame = BlzCreateFrameByType('BACKDROP', "PORTRAIT", main_frame, "",0)
            BlzFrameSetPoint(new_Frame, FRAMEPOINT_TOPLEFT, main_frame, FRAMEPOINT_TOPLEFT, 0.02, -0.02)
            BlzFrameSetSize(new_Frame, 0.0435, 0.0435)
            LibrarianFrame[player].portrait = new_Frame

            new_Frame = BlzCreateFrameByType("TEXT", "shop name", LibrarianFrame[player].portrait, "", 0)
            BlzFrameSetPoint(new_Frame, FRAMEPOINT_LEFT, LibrarianFrame[player].portrait, FRAMEPOINT_RIGHT, 0.011, 0.)
            BlzFrameSetTextAlignment(new_Frame, TEXT_JUSTIFY_MIDDLE, TEXT_JUSTIFY_LEFT)
            BlzFrameSetScale(new_Frame, 1.35)
            LibrarianFrame[player].name = new_Frame

            LibrarianFrame[player].categories_border = BlzCreateFrame('EscMenuBackdrop', main_frame, 0, 0)
            BlzFrameSetPoint(LibrarianFrame[player].categories_border, FRAMEPOINT_BOTTOMLEFT, main_frame, FRAMEPOINT_BOTTOMLEFT, 0.015, 0.015)
            BlzFrameSetPoint(LibrarianFrame[player].categories_border, FRAMEPOINT_BOTTOMRIGHT, main_frame, FRAMEPOINT_BOTTOMRIGHT, -0.015, -0.015)
            BlzFrameSetSize(LibrarianFrame[player].categories_border, 0.1, 0.07)

            LibrarianFrame[player].categories = {}

            LibrarianFrame[player].categories[1] = NewButton(2, "GUI\\inventory_slot.blp", 0.04, 0.04, LibrarianFrame[player].categories_border, FRAMEPOINT_BOTTOMLEFT, FRAMEPOINT_BOTTOMLEFT, 0.015, 0.015, LibrarianFrame[player].categories_border)
            for i = 2, 5 do
                LibrarianFrame[player].categories[i] = NewButton(2, "GUI\\inventory_slot.blp", 0.04, 0.04, LibrarianFrame[player].categories[i-1], FRAMEPOINT_LEFT, FRAMEPOINT_RIGHT, 0.01, 0., LibrarianFrame[player].categories_border)
            end

            LibrarianFrame[player].last_category = 1

            local button_data = GetButtonData(LibrarianFrame[player].categories[1])
            BlzFrameSetTexture(button_data.image, "ReplaceableTextures\\CommandButtons\\BTNSelectHeroOn.blp", 0, true)
            FrameChangeTexture(button_data.button, "ReplaceableTextures\\CommandButtons\\BTNSelectHeroOn.blp")

            new_Frame = BlzCreateFrame('EscMenuBackdrop', main_frame, 0, 0)
            BlzFrameSetPoint(new_Frame, FRAMEPOINT_BOTTOMLEFT, LibrarianFrame[player].categories_border, FRAMEPOINT_TOPLEFT, 0., 0.)
            BlzFrameSetPoint(new_Frame, FRAMEPOINT_BOTTOMRIGHT, LibrarianFrame[player].categories_border, FRAMEPOINT_TOPRIGHT, 0., 0.)
            BlzFrameSetSize(new_Frame, 0.1, 0.07)
            LibrarianFrame[player].inner_exchange_border = new_Frame

            new_Frame = BlzCreateFrame('EscMenuBackdrop', LibrarianFrame[player].inner_exchange_border, 0, 0)
            LibrarianFrame[player].exchange_item_slot = NewButton(0, "GUI\\inventory_slot.blp", 0.04, 0.04, LibrarianFrame[player].inner_exchange_border, FRAMEPOINT_TOPLEFT, FRAMEPOINT_TOPLEFT, 0.015, -0.015, LibrarianFrame[player].inner_exchange_border)
            BlzFrameSetPoint(new_Frame, FRAMEPOINT_BOTTOMLEFT, LibrarianFrame[player].exchange_item_slot, FRAMEPOINT_BOTTOMLEFT, -0.015, -0.015)
            BlzFrameSetPoint(new_Frame, FRAMEPOINT_TOPRIGHT, LibrarianFrame[player].exchange_item_slot, FRAMEPOINT_TOPRIGHT, 0.015, 0.015)

            LibrarianFrame[player].exchange_button = NewSpecialButton(LOCALE_LIST[my_locale].EXCHANGE_BUTTON_TEXT, 0.06, 0.04, LibrarianFrame[player].exchange_item_slot, FRAMEPOINT_LEFT, FRAMEPOINT_RIGHT, 0.025, 0., LibrarianFrame[player].inner_exchange_border)
            new_Frame = CreateTextBox(player, 0.085, 0.03, 1., LibrarianFrame[player].exchange_button, FRAMEPOINT_LEFT, FRAMEPOINT_RIGHT, 0.0015, 0., main_frame)
            CreateTooltip(LOCALE_LIST[my_locale].UI_TOOLTIP_EXCHANGE_TITLE, LOCALE_LIST[my_locale].UI_TOOLTIP_EXCHANGE_DESC, LibrarianFrame[player].exchange_button, 0.125, 0.06)
            LibrarianFrame[player].masterframe = BlzCreateFrameByType("BACKDROP", "ButtonIcon", new_Frame, "", 0)


            LibrarianFrame[player].tooltip = NewTooltip(LibrarianFrame[player].masterframe)

            LibrarianFrame[player].main_frame = main_frame
            BlzFrameSetVisible(LibrarianFrame[player].main_frame, false)
            LibrarianFrame[player].state = false

    end


    ---@param unit_owner unit
    ---@param texture string
    function CreateLibrarian(unit_owner, texture)


        LibrarianFrame = {}

        AddSpecialEffectTarget("Marker\\LibrarianIcon.mdx", unit_owner, "overhead")

        ClickTrigger = CreateTrigger()
        TriggerAddAction(ClickTrigger, function()
            local button = GetButtonData(BlzGetTriggerFrame())
            local player = GetPlayerId(GetTriggerPlayer()) + 1
            local exchange_button = GetButtonData(LibrarianFrame[player].exchange_item_slot)

             if button.item then
                 button.item = nil
                 BlzFrameSetTexture(button.image, "GUI\\inventory_slot.blp", 0, true)
                 BlzFrameSetText(LibrarianFrame[player].exchange_frame, "")
                 LibrarianFrame[player].exchange_cost = 0
                 RemoveTooltip(player)
             elseif button.button_type == 1 and exchange_button.item then
                 local unit_data = GetUnitData(PlayerHero[player])
                 local item_data = GetItemData(exchange_button.item)
                 local gold = GetPlayerState(Player(player - 1), PLAYER_STATE_RESOURCE_GOLD)

                 if item_data.restricted_to then
                     if item_data.restricted_to == unit_data.unit_class then
                         Feedback_CantUse(player)
                     else
                         if gold >= LibrarianFrame[player].exchange_cost then
                             SetPlayerState(Player(player - 1), PLAYER_STATE_RESOURCE_GOLD, gold - LibrarianFrame[player].exchange_cost)
                             PlayLocalSound("Sound\\altarshop_buymagicspell.wav", player-1, 115)
                             BlzFrameSetText(LibrarianFrame[player].exchange_frame, "")
                             LibrarianFrame[player].exchange_cost = 0
                             local quality = item_data.QUALITY
                             DropItemFromInventory(player, exchange_button.item)
                             RemoveCustomItem(exchange_button.item)
                             exchange_button.item = nil
                             UpdateLibrarianWindow(player)

                             local category_button = GetButtonData(LibrarianFrame[player].categories[LibrarianFrame[player].last_category])
                             local new_book

                             if category_button.category then
                                 new_book = CreateCustomItem(GetBookClassCategory(unit_data.unit_class, quality, category_button.category), 0.,0., false)
                             else
                                 new_book = CreateCustomItem(GetRandomBookClass(unit_data.unit_class, quality), 0.,0., false)
                             end


                             AddToInventory(player, new_book)
                         else
                             Feedback_NoGold(player)
                         end
                     end
                 end
             elseif button.button_type == 2 then
                 for i = 1, 5 do
                     local cat_data = GetButtonData(LibrarianFrame[player].categories[i])
                     if cat_data.button == button.button then
                         local last_cat_data = GetButtonData(LibrarianFrame[player].categories[LibrarianFrame[player].last_category])
                         BlzFrameSetVisible(last_cat_data.sprite, false)
                         LibrarianFrame[player].last_category = i
                         UpdateLibrarianWindow(player)
                         PlayLocalSound("Sound\\Interface\\AutoCastButtonClick1.wav", player-1)
                         break
                     end
                 end
             end

        end)

        LeaveTrigger = CreateTrigger()
        TriggerAddAction(LeaveTrigger, function()
            local button = GetButtonData(BlzGetTriggerFrame())
            local player = GetPlayerId(GetTriggerPlayer()) + 1

                if button.item then
                    RemoveTooltip(player)
                end

        end)

        EnterTrigger = CreateTrigger()
        TriggerAddAction(EnterTrigger, function()
            local button = GetButtonData(BlzGetTriggerFrame())
            local player = GetPlayerId(GetTriggerPlayer()) + 1

            if button.item then
                ShowItemTooltip(button.item, LibrarianFrame[player].tooltip, button, player, FRAMEPOINT_RIGHT)
            else
                RemoveTooltip(player)
            end

        end)

        local soundpack = {
            open = {
                "Units\\NightElf\\Runner\\RunnerWhat2.wav",
                "Units\\NightElf\\Runner\\RunnerWhat5.wav"
            }
        }

            for i = 1, 6 do
                DrawLibrarianFrames(i)
                BlzFrameSetTexture(LibrarianFrame[i].portrait, texture, 0, true)
                BlzFrameSetText(LibrarianFrame[i].name, GetUnitName(unit_owner))
            end


            CreateNpcData(unit_owner, GetUnitName(unit_owner))
            AddInteractiveOption(unit_owner, { name = GetLocalString("Книги", "Books"), id = "librarian_exchange_conv", feedback = function(clicked, clicking, player)
                local id = player - 1
                --local player = id + 1

                    if id <= 5 then

                        if GetLocalPlayer() == Player(id) then BlzFrameSetVisible(LibrarianFrame[player].main_frame, true) end
                        LibrarianFrame[player].state = true
                        UpdateLibrarianWindow(player)
                        if soundpack then
                            PlayLocalSound(soundpack.open[GetRandomInt(1, #soundpack.open)], id, 125)
                        end

                        local unit_class = GetUnitClass(PlayerHero[player])

                        for i = 2, 5 do
                            local button_data = GetButtonData(LibrarianFrame[player].categories[i])

                            if CLASS_SKILL_CATEGORY[unit_class][i-1] then
                                BlzFrameSetTexture(button_data.image, SKILL_CATEGORY_ICON[CLASS_SKILL_CATEGORY[unit_class][i-1]], 0, true)
                                FrameChangeTexture(button_data.button, SKILL_CATEGORY_ICON[CLASS_SKILL_CATEGORY[unit_class][i-1]])
                                button_data.category = CLASS_SKILL_CATEGORY[unit_class][i-1]
                            else
                                BlzFrameSetVisible(button_data.button, false)
                            end
                        end

                            local timer = CreateTimer()
                            TimerStart(timer, 0.1, true, function()
                                if not IsUnitInRange(clicking, unit_owner, 299.) or IsUnitHidden(unit_owner) or GetUnitState(clicking, UNIT_STATE_LIFE) < 0.045 then
                                    --DestroySlider(player)
                                    RemovePlayerItems(player)
                                    DestroyContextMenu(player)
                                    RemoveTooltip(player)
                                    --ShopInFocus[player] = nil
                                    LibrarianFrame[player].state = false
                                    if GetLocalPlayer() == Player(id) then BlzFrameSetVisible(LibrarianFrame[player].main_frame, false) end
                                    DestroyTimer(timer)
                                    if soundpack then
                                        PlayLocalSound(soundpack.close[GetRandomInt(1, #soundpack.open)], id, 125)
                                    end
                                end
                            end)


                    end

            end})

    end


end