---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by MSI.
--- DateTime: 01.09.2021 17:24
---
do




    function TraitBurningEffect(unit)
        local timer = CreateTimer()

            TimerStart(timer, 0.33, true, function()
                if GetUnitState(unit) > 0.045 then
                    ApplyEffect(unit, nil, 0.,0., "EBtrait", Current_Wave)
                else
                    DestroyTimer(timer)
                end
            end)

    end



    function CreateArcaneLaser(unit)
        local timer = CreateTimer()
        local duration = 6.
        local starting_angle = GetRandomReal(0., 359.)
        local x = GetUnitX(unit); local y = GetUnitY(unit)
        local max_distance = GetMaxAvailableDistance(x, y, starting_angle, GetRandomReal(100., 400.))
        x = GetUnitX(unit) + Rx(max_distance, starting_angle)
        y = GetUnitY(unit) + Ry(max_distance, starting_angle)
        local z = GetZ(x, y) + 35.
        starting_angle = GetRandomReal(0., 359.)
        local angle_step = (1. / 75.) / 0.025
        local lightning = AddLightningEx("MYPA", true, x, y, z, x + Rx(550., starting_angle), y + Ry(550., starting_angle), z)
        local sfx = AddSpecialEffect("Abilities\\Spells\\Human\\ManaFlare\\ManaFlareTarget.mdx", x, y)

        BlzSetSpecialEffectZ(sfx, z)

        if GetRandomInt(1, 2) == 2 then
            angle_step = angle_step * -1
        end

        local sound = CreateNew3DSound("Trait_Arcane_Loop_".. GetRandomInt(1,2) ..".wav", x, y, z, 110, 1500., 4000., true)
        StartSound(sound)

        local player_entity = GetOwningPlayer(unit)

        local group = CreateGroup()
        local hit_group = CreateGroup()
        local radius = 40.
        local half_radius = radius / 4.
        local range_steps = math.ceil(550. / half_radius) + 1

            TimerStart(timer, 0.025, true, function()
                if duration < 0. then
                    DestroyTimer(timer)
                    DestroyLightning(lightning)
                    DestroyEffect(sfx)
                    DestroyGroup(group)
                    DestroyGroup(hit_group)
                    StopSound(sound, true, false)
                else
                    local second_group = CreateGroup()
                    starting_angle = starting_angle + angle_step
                    MoveLightningEx(lightning, true, x, y, z, x + Rx(550., starting_angle), y + Ry(550., starting_angle), z)

                    local step_x = x; local step_y = y

                    for i = 1, range_steps do
                        GroupEnumUnitsInRange(group, step_x, step_y, radius, nil)
                        for index = BlzGroupGetSize(group) - 1, 0, -1 do
                            GroupAddUnit(second_group, BlzGroupUnitAt(group, index))
                        end
                        step_x = step_x + Rx(half_radius, starting_angle)
                        step_y = step_y + Ry(half_radius, starting_angle)
                    end

                    for index = BlzGroupGetSize(second_group) - 1, 0, -1 do
                        local picked = BlzGroupUnitAt(second_group, index)
                        if IsUnitEnemy(picked, player_entity) and GetUnitState(picked, UNIT_STATE_LIFE) > 0.045 and GetUnitAbilityLevel(picked, FourCC("Avul")) == 0 and not IsUnitInGroup(picked, hit_group) then
                            ApplyEffect(unit, picked, 0.,0., "EAtrait", Current_Wave)
                            GroupAddUnit(hit_group, picked)
                            DelayAction(0.25, function() if hit_group then GroupRemoveUnit(hit_group, picked) end end)
                        end
                    end

                    DestroyGroup(second_group)
                    duration = duration - 0.025
                end
            end)

    end


    function TraitArcaneEffect(unit)
        local timer = CreateTimer()

            TimerStart(timer, 2., true, function()
                if GetUnitState(unit) > 0.045 then
                    if IsAnyHeroInRange(GetUnitX(unit), GetUnitY(unit), 700.) then
                        local unit_data = GetUnitData(unit)

                            if not unit_data.arcane_trait_timer then
                                unit_data.arcane_trait_timer = CreateTimer()

                                TimerStart(unit_data.arcane_trait_timer, 10., false, function()
                                    DestroyTimer(unit_data.arcane_trait_timer)
                                    unit_data.arcane_trait_timer = nil
                                end)

                                for i = 1, GetRandomInt(1, 3) do
                                    DelayAction(GetRandomReal(0.5, 3.), function() CreateArcaneLaser(unit) end)
                                end

                            end

                    end
                else
                    DestroyTimer(timer)
                end
            end)

    end



    function CreateToxicPool(unit, position_x, position_y)
        local timer = CreateTimer()
        local duration = 7.
        local sfx = AddSpecialEffect("Abilities\\Spells\\Undead\\PlagueCloud\\PlagueCloudCaster.mdx", position_x, position_y)

            AddSoundVolume("Trait_Toxic_".. GetRandomInt(1,3) ..".wav", position_x, position_y, 120, 1500.)
            BlzSetSpecialEffectScale(sfx, 1.35)

            TimerStart(timer, 0.33, true, function()
                if duration > 0. then
                    ApplyEffect(unit, nil, position_x, position_y, "ETtrait", Current_Wave)
                else
                    DestroyTimer(timer)
                    DestroyEffect(sfx)
                end
                duration = duration - 0.33
            end)


    end


    function TraitToxicEffect(unit)
        local unit_data = GetUnitData(unit)

        if not unit_data.toxic_trait_timer then
            unit_data.toxic_trait_timer = CreateTimer()

                TimerStart(unit_data.toxic_trait_timer, 2.25, false, function()
                    DestroyTimer(unit_data.toxic_trait_timer)
                    unit_data.toxic_trait_timer = nil
                end)

            CreateToxicPool(unit, GetUnitX(unit), GetUnitY(unit))

        end

    end



    function TraitLightningEffect(unit)
        local unit_data = GetUnitData(unit)

            if not unit_data.lightning_trait_timer then

                unit_data.lightning_trait_timer = CreateTimer()

                TimerStart(unit_data.lightning_trait_timer, 1.5, false, function()
                    DestroyTimer(unit_data.lightning_trait_timer)
                    unit_data.lightning_trait_timer = nil
                end)

                local discharge = {}
                local spark_amount = 6
                local angle = 360. / spark_amount
                local current_angle = GetRandomReal(1., 359.)


                for i = 1, spark_amount do
                    discharge[i] = { missile = ThrowMissile(unit, nil, 'MLtrait', nil, GetUnitX(unit), GetUnitY(unit), 0, 0, current_angle), a = current_angle }
                    BlzSetSpecialEffectScale(discharge[i].missile.missile_effect, 1.15)
                    current_angle = current_angle + angle
                end

                    for i = 1, spark_amount do
                        local timer = CreateTimer()
                        local timeout = GetRandomReal(0.22, 0.65)

                            TimerStart(timer, 0.05, true, function()
                                if discharge[i].missile.time > 0. then
                                    if timeout <= 0. then
                                        RedirectMissile_Deg(discharge[i].missile, discharge[i].a + GetRandomReal(-15., 15.))
                                        timeout = GetRandomReal(0.22, 0.65)
                                    end
                                    timeout = timeout - 0.05
                                else
                                    discharge[i] = nil
                                    DestroyTimer(timer)
                                end
                            end)

                    end

            end

    end


end