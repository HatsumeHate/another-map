---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by hatsu.
--- DateTime: 20.05.2023 23:17
---
do



    function CurvedStrikeEffect(source)
        local unit_data = GetUnitData(source)

            if unit_data.curved_strike_stacks then
                if unit_data.curved_strike_stacks < 3 then
                    unit_data.curved_strike_stacks = unit_data.curved_strike_stacks + 1
                end
            else
                unit_data.curved_strike_stacks = 1
            end

    end


    function BreakthroughEffect(caster, target, point_x, point_y, ability_instance)
        local unit_data = GetUnitData(caster)
        local angle  = target and AngleBetweenUnits(caster, target) or AngleBetweenUnitXY(caster, point_x, point_y)
        local max_range = GetMaxAvailableDistance(GetUnitX(caster), GetUnitY(caster), angle, 400.)

            unit_data.breakthrough_ability_instance = ability_instance
            ChargeUnit(caster, 1500., max_range, angle, 3000, 75., "stand", "BreakthroughEffect", { effect = "Effect\\ChargerDarkCasterArt.mdx", point = "origin", scale = 0.7 })
            unit_data.breakthrough_charge_sfx = AddSpecialEffectTarget("Spell\\Valiant Charge Void", caster, "origin")

    end


    function LockedAndLoadedEffect(source)
        local player = GetPlayerId(GetOwningPlayer(source))+1

            for key = KEY_Q, KEY_F do
                if KEYBIND_LIST[key].player_skill_bind[player] and KEYBIND_LIST[key].player_skill_bind[player] > 0 and KEYBIND_LIST[key].player_skill_bind[player] ~= FourCC("AALL") then
                    BlzEndUnitAbilityCooldown(source, KEYBIND_LIST[key].ability)
                end
            end

            ApplyBuff(source, source, "ABLL", UnitGetAbilityLevel(source, "AALL"))

    end


    function NightShroudEffect(source)
        local nova = AddSpecialEffect("Effect\\DarkLightningNova.mdx", GetUnitX(source), GetUnitY(source))

            DestroyEffect(AddSpecialEffect("Effect\\DarkLightning.mdx", GetUnitX(source), GetUnitY(source)))
            BlzSetSpecialEffectScale(nova, 0.5)
            DestroyEffect(nova)
            ApplyBuff(source, source, "ABNS", UnitGetAbilityLevel(source, "AANS"))

    end


    function StackBladeOfDarkness(source)
        local unit_data = GetUnitData(source)
    
            if unit_data.blade_of_darkness_stacks then

                if unit_data.blade_of_darkness_stacks < 10 then
                    unit_data.blade_of_darkness_stacks = unit_data.blade_of_darkness_stacks + 1
                end

            else
                unit_data.blade_of_darkness_stacks = 1
            end

            print(unit_data.blade_of_darkness_stacks)
    end


    function ShadowstepEffect(source, target)
        local facing = GetUnitFacing(target) + 180.

            SetUnitPosition(source, GetUnitX(target) + Rx(50., facing), GetUnitY(target) + Ry(50., facing))
            BlzSetUnitFacingEx(source, facing - 180.)
            ApplyBuff(source, source, "ABST", UnitGetAbilityLevel(source, "AAST"))
            AddSoundVolume("Sounds\\Spells\\Shadowstep_Reappear_".. GetRandomInt(1, 2) ..".wav", GetUnitX(target), GetUnitY(target), 150, 1500.)
    end


    function CaltropsEffect(source, ability_instance)

        CreateAuraOnPoint(source, GetUnitX(source), GetUnitY(source), "caltrops_aura", 1, ability_instance)

    end


    function ShockingTrapEffect(source, ability_instance)
        local timer = CreateTimer()
        local group = CreateGroup()
        local x,y = GetUnitX(source), GetUnitY(source)
        local player = GetOwningPlayer(source)
        local effect = AddSpecialEffect("Effect\\Crystal Beartrap SD.mdx", x, y)
        local duration = 16.

            BlzSetSpecialEffectScale(effect, 0.35)

            TimerStart(timer, 0.1, true, function()
                GroupEnumUnitsInRange(group, x, y, 150., nil)

                    for index = BlzGroupGetSize(group) - 1, 0, -1 do
                        local picked = BlzGroupUnitAt(group, index)

                            if IsUnitEnemy(picked, player) and GetUnitState(picked, UNIT_STATE_LIFE) > 0.045 and GetUnitAbilityLevel(picked, FourCC("Avul")) then
                                ApplyEffect(source, nil, x, y, "shocking_trap_effect", 1, ability_instance)
                                BlzSpecialEffectAddSubAnimation(effect, SUBANIM_TYPE_ALTERNATE_EX)
                                DestroyTimer(timer)
                                DestroyGroup(group)
                                DestroyEffect(effect)
                                break
                            end

                    end

                GroupClear(group)

                duration = duration - 0.1

                    if duration <= 0. then
                        DestroyTimer(timer)
                        DestroyGroup(group)
                        DestroyEffect(effect)
                    end

            end)

    end


    function BladeTrapEffect(source, ability_instance)
        local timer = CreateTimer()
        local group = CreateGroup()
        local x,y = GetUnitX(source), GetUnitY(source)
        local player = GetOwningPlayer(source)
        local effect = AddSpecialEffect("Effect\\Crystal Beartrap SD.mdx", x, y)
        local duration = 16.

            BlzSetSpecialEffectScale(effect, 0.35)

            TimerStart(timer, 0.1, true, function()
                GroupEnumUnitsInRange(group, x, y, 150., nil)

                    for index = BlzGroupGetSize(group) - 1, 0, -1 do
                        local picked = BlzGroupUnitAt(group, index)

                            if IsUnitEnemy(picked, player) and GetUnitState(picked, UNIT_STATE_LIFE) > 0.045 and GetUnitAbilityLevel(picked, FourCC("Avul")) then
                                local sfx = AddSpecialEffect("Abilities\\Spells\\NightElf\\FanOfKnives\\FanOfKnivesCaster.mdx", x, y)
                                local sfx45 = AddSpecialEffect("Abilities\\Spells\\NightElf\\FanOfKnives\\FanOfKnivesCaster.mdx", x, y)

                                    BlzSetSpecialEffectScale(sfx, 0.5)
                                    BlzSetSpecialEffectScale(sfx45, 0.5)
                                    BlzSetSpecialEffectYaw(sfx45, 45.)
                                    DelayAction(1.6, function()  DestroyEffect(sfx); DestroyEffect(sfx45) end)
                                    ApplyEffect(source, nil, x, y, "blade_trap_effect", 1, ability_instance)
                                    BlzSpecialEffectAddSubAnimation(effect, SUBANIM_TYPE_ALTERNATE_EX)
                                    DestroyTimer(timer)
                                    DestroyGroup(group)
                                    DestroyEffect(effect)

                                break
                            end

                    end

                GroupClear(group)

                duration = duration - 0.1

                    if duration <= 0. then
                        DestroyTimer(timer)
                        DestroyGroup(group)
                        DestroyEffect(effect)
                    end

            end)

    end

end