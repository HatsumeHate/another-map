---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by MSI.
--- DateTime: 30.05.2021 15:47
---
do


    local BroodRegions = 0
    local WebRegions = 0


    function SummonTentacle(caster, x, y)
        local angle = GetRandomReal(0., 359.)
        local range = GetRandomReal(50., 250.)
        local max_range = GetMaxAvailableDistance(x, y, angle, range)

            local tentacle = CreateUnit(SECOND_MONSTER_PLAYER, FourCC("u00I"), x + Rx(max_range, angle), y + Ry(max_range, angle), GetRandomReal(0., 359.))
            SetUnitAnimation(tentacle, "birth")
            SafePauseUnit(tentacle, true)
            DelayAction(0.667, function()
                SafePauseUnit(tentacle, false)
                UnitApplyTimedLife(tentacle, 0, 15.)
            end)

    end


    function PoisonBarrage(caster, x, y)
        local timer = CreateTimer()
        local missile_amount = 4
        local angle_delta = 40. / missile_amount
        local throw_angle = AngleBetweenUnitXY(caster, x, y) - 40.


        ThrowMissile(caster, nil, "poison_barrage_missile", nil, GetUnitX(caster), GetUnitY(caster), 0.,0., throw_angle)

            TimerStart(timer, 0.17, true, function()
                if missile_amount > 0 then
                    throw_angle = throw_angle + angle_delta
                    ThrowMissile(caster, nil, "poison_barrage_missile", nil, GetUnitX(caster), GetUnitY(caster), 0.,0., throw_angle)
                    missile_amount = missile_amount - 1
                else
                    DestroyTimer(timer)
                end
            end)

    end


    function CreateAndarielHellfire(caster, x, y)
        local sfx = AddSpecialEffect("Effect\\Flame of Darkness.mdx", x, y)
        local duration = 6.

            BlzSetSpecialEffectYaw(sfx, GetRandomReal(0., 360) * bj_DEGTORAD)
            TimerStart(CreateTimer(), 0.33, true, function()
                ApplyEffect(caster, nil, x, y, "andariel_hellfire_effect", 1)
                duration = duration - 0.33
                if duration <= 0. then
                    DestroyEffect(sfx)
                    DestroyTimer(GetExpiredTimer())
                end
            end)

    end


    function AndarielHellfireCast(caster)
        local amount = GetRandomInt(7, 9)
        local starting_angle = GetRandomReal(0.01, 360.)
        local step = 360. / amount
        local missile_pack = {}
        local original_angle = {}
        local dispersion = 45.

            for i = 1, amount do
                missile_pack[i] = ThrowMissile(caster, nil, "andariel_fire_missile", nil, GetUnitX(caster), GetUnitY(caster), 0, 0, starting_angle)
                original_angle[i] = starting_angle
                starting_angle = starting_angle + step
            end

            local timer = CreateTimer()
            TimerStart(timer, 0.01, true, function ()
                for i = 1, amount do
                    if missile_pack[i].time <= 0. then DestroyTimer(timer)
                    else if GetRandomInt(1, 7) == 1 then RedirectMissile_Deg(missile_pack[i], original_angle[i] + GetRandomReal(-dispersion, dispersion)) end end
                end
            end)

            local timer2 = CreateTimer()
            TimerStart(timer2, 0.1, true, function ()
                for i = 1, amount do
                    if missile_pack[i].time <= 0. then DestroyTimer(timer2)
                    else CreateAndarielHellfire(caster, missile_pack[i].current_x, missile_pack[i].current_y) end
                end
            end)

    end


    function SpiderQueen_SpawnBrood(boss)
        --local rect = BroodRegions[GetRandomInt(1, #BroodRegions)]
        local x = GetUnitX(boss); local y = GetUnitY(boss)
        local total_egg_count = GetRandomInt(3, 5)
        --local distance = GetRandomInt(200, 400)


           -- if GetRandomInt(1,2) == 1 then distance = distance * -1 end

            for i = 1, total_egg_count do
                local angle = GetRandomReal(0., 359.)
                local max_range = GetMaxAvailableDistance(x, y, angle, GetRandomInt(250, 500))
                local egg = CreateUnit(SECOND_MONSTER_PLAYER, GetRandomInt(1,2) == 1 and FourCC("speg") or FourCC("speb"), x + Rx(max_range, angle), y + Ry(max_range, angle), GetRandomReal(0., 359.))

                    DelayAction(10., function()
                        if GetUnitState(egg, UNIT_STATE_LIFE) > 0.045 then
                            KillUnit(egg)
                            local spider = CreateUnit(SECOND_MONSTER_PLAYER, FourCC("n00Y"), GetUnitX(egg), GetUnitY(egg), RndAng())
                            DelayAction(0.001, function()
                                local unit_data = GetUnitData(spider)
                                unit_data.classification = 0
                                --ScaleMonsterUnit(spider)
                            end)
                        end
                    end)

            end


    end


    function SpiderQueen_WebTrap(boss)
        local rect = Rect(-16., -16., 16., 16)
        local angle = GetRandomReal(0., 359.)
        local max_range = GetMaxAvailableDistance(GetUnitX(boss), GetUnitY(boss), angle, GetRandomInt(200, 400))


            local x = GetUnitX(boss) + Rx(max_range, angle)
            local y = GetUnitY(boss) + Ry(max_range, angle)

            MoveRectTo(rect, x, y)
            local web_effect = AddSpecialEffect("Abilities\\Spells\\Undead\\Web\\WebTarget.mdx", x, y)
            BlzSetSpecialEffectHeight(web_effect, 84.)
            BlzSetSpecialEffectScale(web_effect, 1.1)

            local trg = CreateTrigger()
            local region = CreateRegion()
            RegionAddRect(region, rect)
            TriggerRegisterEnterRegion(trg, region, nil)
            TriggerAddAction(trg, function()
                if IsUnitEnemy(GetTriggerUnit(), MONSTER_PLAYER) and GetUnitAbilityLevel(GetTriggerUnit(), FourCC("Avul")) == 0 then
                    ApplyBuff(boss, GetTriggerUnit(), "A01T", 1)
                    RemoveRegion(region)
                    RemoveRect(rect)
                    DestroyTrigger(trg)
                    DestroyEffect(web_effect)
                    trg = nil
                end
            end)

        DelayAction(35., function()
            if trg then
                RemoveRegion(region)
                RemoveRect(rect)
                DestroyTrigger(trg)
                DestroyEffect(web_effect)
            end
        end)

    end


    function CreatePoisonNova(boss)
        local missiles = 9
        local angle = 360. / missiles
        local current_angle = 0.01

            for i = 1, missiles do
                ThrowMissile(boss, nil, 'MAPN', nil, GetUnitX(boss), GetUnitY(boss), 0, 0, current_angle)
                current_angle = current_angle + angle
            end

    end


    function SpawnSkeletons(boss)
        local amount = 5
        local x = GetUnitX(boss); local y = GetUnitY(boss)
        local delay = 0.

        for i = 1, amount do
            local angle = GetRandomReal(0., 359.)
            local max_range = GetMaxAvailableDistance(x, y, angle, GetRandomInt(350, 625))

            DelayAction(delay, function()
                ThrowMissile(boss, nil, 'MSSK', nil, x, y, x + Rx(max_range, angle), y + Ry(max_range, angle), angle)
            end)
            delay = delay + 0.14
        end

    end


    function LightningNovaBoss(boss)
        local amount = 14
        local angle = 360. / amount
        local current_angle = 0.01
        local x = GetUnitX(boss); local y = GetUnitY(boss)

        for i = 1, amount do
            local missile = ThrowMissile(boss, nil, 'MMLN', nil, x, y, 0., 0., current_angle)
            local timer = CreateTimer()
            local timeout = GetRandomReal(0.09, 0.18)
            local missile_angle = current_angle

                TimerStart(timer, 0.025, true, function()
                    if missile.time > 0. then

                        if timeout <= 0. then
                            --print(missile.time)
                            missile_angle = missile_angle + GetRandomReal(-37., 37.)
                            RedirectMissile_Deg(missile, missile_angle)
                            timeout = GetRandomReal(0.09, 0.18)
                            --print("a2")
                        end

                        timeout = timeout - 0.025
                    else
                        DestroyTimer(timer)
                    end
                end)

            current_angle = current_angle + angle
        end


    end


    function SummonCurse(missile)

        DelayAction(4., function()
            if missile and missile.time > 0. then
                missile.time = 0.
            end
        end)

    end

    function MephistoSouls(boss)
        local enemies = CreateGroup()

        local timer = CreateTimer()
        TimerStart(timer, 6., true, function()

            if GetUnitState(boss, UNIT_STATE_LIFE) > 0.045 then

                GroupClear(enemies)
                GroupEnumUnitsInRange(enemies, GetUnitX(boss), GetUnitY(boss), 450., nil)

                for index = BlzGroupGetSize(enemies) - 1, 0, -1 do
                    local picked = BlzGroupUnitAt(enemies, index)
                    if not IsUnitEnemy(picked, MONSTER_PLAYER) or GetUnitState(picked, UNIT_STATE_LIFE) <= 0.045 or GetUnitAbilityLevel(picked, FourCC("Avul")) > 0 then
                        GroupRemoveUnit(enemies, picked)
                    end
                end

                if BlzGroupGetSize(enemies) > 0 then
                    local target = RandomFromGroup(enemies)
                    local ghost = CreateUnit(MONSTER_PLAYER, FourCC("u00H"), GetUnitX(target) + GetRandomReal(-250., 250.), GetUnitY(target) + GetRandomReal(-250., 250.), GetRandomReal(0., 359.))

                    SetUnitVertexColor(ghost, 59, 155, 255, 125)
                    DelayAction(2., function()
                        KillUnit(ghost)
                        ShowUnit(ghost, false)
                    end)

                end
            else
                DestroyGroup(enemies)
                DestroyTimer(GetExpiredTimer())
            end

        end)

    end


    function CreateAstralBarragePoint(unit)
        local angle = GetRandomReal(0., 359.)
        local distance = GetMaxAvailableDistance(GetUnitX(unit), GetUnitY(unit), angle, GetRandomReal(0., 500.))
        local point_x, point_y = GetUnitX(unit) + Rx(distance, angle), GetUnitY(unit) + Ry(distance, angle)

            CreateSpellCircle("Effect\\Spell Marker Blue.mdx", point_x, point_y, 1.4, 1.2, 0.8, function() ApplyEffect(unit, nil, point_x, point_y, "astral_barrage_effect", 1) end)

    end

    function AstralBarrageCast(unit)
        local duration = 4.

            CreateAstralBarragePoint(unit)

            TimerStart(CreateTimer(), 0.66, true, function()
                duration = duration - 0.66

                    if duration < 0. then
                        DestroyTimer(GetExpiredTimer())
                    else
                        CreateAstralBarragePoint(unit)
                    end

            end)

    end


    function BloodRavenReviveCast(unit)

        for i = 1, 2 do
            local angle = GetRandomReal(0., 359.)
            local distance = GetMaxAvailableDistance(GetUnitX(unit), GetUnitY(unit), angle, GetRandomReal(150., 500.))
            local point_x = GetUnitX(unit) + Rx(distance, angle)
            local point_y = GetUnitY(unit) + Ry(distance, angle)
            local summoned = CreateUnit(MONSTER_PLAYER, FourCC("n02M"), point_x, point_y, angle)
            DestroyEffect(AddSpecialEffect("Abilities\\Spells\\Undead\\AnimateDead\\AnimateDeadTarget.mdx", point_x, point_y))
            SetUnitAnimation(summoned, "birth")
            UnitAddAbility(summoned, FourCC("Avul"))
            SafePauseUnit(summoned, true)
            DelayAction(2.333, function()
                UnitApplyTimedLife(summoned, 0, 40.)
                SafePauseUnit(summoned, false)
                SetUnitAnimation(summoned, "stand")
                UnitRemoveAbility(summoned, FourCC("Avul"))
            end)
        end

    end


    function ReanimatedArrowBarrage(unit, point_x, point_y)

        for i = 1, 4 do
            DelayAction(0.2 * i, function()
                local angle = GetRandomReal(0., 359.)
                local distance = GetMaxAvailableDistance(point_x, point_y, angle, GetRandomReal(0., 300.))
                local circle_x, circle_y = point_x + Rx(distance, angle), point_y + Ry(distance, angle)

                    CreateSpellCircle("Effect\\Spell Marker Gray.mdx", circle_x, circle_y, 1.2, 1., 0.8, function()
                        for i = 1, 8 do
                            DelayAction(GetRandomReal(0., 0.16), function()
                                local x, y = circle_x + GetRandomReal(-100., 100.), circle_y + GetRandomReal(-100., 100.)
                                local arrow = ThrowMissile(unit, nil, "reanimated_arrow_barrage_missile", nil, x, y, x, y, 1., false)
                                BlzSetSpecialEffectPitch(arrow.my_missile, math.rad(90.))
                                --arrow.time = 9999.
                            end)
                        end
                        --ApplyEffect(unit, nil, circle_x, circle_y, "reanimated_arrow_barrage_effect", 1)
                    end)
            end)
        end

    end


    function DiabloLightningBreath(unit, x, y)
        local unit_data = GetUnitData(unit)
        local angle = GetUnitFacing(unit)
        local sfx = AddSpecialEffect("Effect\\lightning_breath.mdx", GetUnitX(unit) + Rx(85., angle), GetUnitY(unit) + Ry(85., angle))

            BlzSetSpecialEffectZ(sfx, GetZ(GetUnitX(unit), GetUnitY(unit)) + 140.)
            BlzSetSpecialEffectYaw(sfx, math.rad(angle))
            TimerStart(unit_data.action_timer, 0., false, nil)
            SetUnitAnimationByIndex(unit, 15)
            SafePauseUnit(unit, true)
            ModifyStat(unit, CONTROL_REDUCTION, 1000, STRAIGHT_BONUS, true)

            local target = GetClosestHeroEx(unit, 1000.)

            local tracking_timer = CreateTimer()
            local update_timer = CreateTimer()
            local anim_cycle_timer = CreateTimer()
            local timer_endcast = CreateTimer()

            TimerStart(tracking_timer, 0.1, true, function()

                if not target or not IsUnitInRange(unit, target, 800.) or GetUnitState(target, UNIT_STATE_LIFE) < 0.045 then
                    target = GetClosestHeroEx(unit, 800.)
                else
                    target = nil
                end

                if target then
                    SetUnitFacingTimed(unit, AngleBetweenUnits(unit, target) + GetRandomReal(-7., 7.), 1.6)
                end

                ThrowMissile(unit, nil, "lightning_breath_missile", nil, GetUnitX(unit), GetUnitY(unit), 0., 0., GetUnitFacing(unit), false)
            end)


            TimerStart(update_timer, 0.025, true, function()

                if GetUnitState(unit, UNIT_STATE_LIFE) < 0.045 then
                    DestroyEffect(sfx)
                    DestroyTimer(anim_cycle_timer)
                    DestroyTimer(update_timer)
                    DestroyTimer(tracking_timer)
                    DestroyTimer(timer_endcast)
                else
                    angle = GetUnitFacing(unit)
                    BlzSetSpecialEffectX(sfx, GetUnitX(unit) + Rx(85., angle))
                    BlzSetSpecialEffectY(sfx, GetUnitY(unit) + Ry(85., angle))
                    BlzSetSpecialEffectZ(sfx, GetZ(GetUnitX(unit), GetUnitY(unit)) + 140.)
                    BlzSetSpecialEffectYaw(sfx, math.rad(angle))
                end

            end)


            TimerStart(anim_cycle_timer, 2., true, function()
                SetUnitAnimationByIndex(unit, 15)
            end)


            TimerStart(timer_endcast, 7., false, function()
                SafePauseUnit(unit, false)
                ResetUnitSpellCast(unit)
                DestroyEffect(sfx)
                DestroyTimer(anim_cycle_timer)
                DestroyTimer(update_timer)
                DestroyTimer(tracking_timer)
                DestroyTimer(timer_endcast)
                SetUnitAnimation(unit, "stand")
                ModifyStat(unit, CONTROL_REDUCTION, 1000, STRAIGHT_BONUS, false)
            end)


    end


    function DiabloFireStomp(unit, x, y)
        local start_x, start_y = GetUnitX(unit), GetUnitY(unit)
        local steps = 1
        local waves = 5
        local range = 135.
        local angle = AngleBetweenUnitXY(unit, x, y)
        local single_angle = 60. / waves
        local fire_waves = {}

            for i = 1, waves do
                fire_waves[i] = angle - (single_angle / 2.) + (60. / 2.) - (single_angle * (i-1))
            end

            ShakeByCoords(GetUnitX(unit), GetUnitY(unit), 4., 0.65, 1600.)
            AddSoundVolume("Sounds\\Spells\\Diablo_Firestomp_Start_0"..GetRandomInt(1,3)..".wav", start_x, start_y, 145, 1600.)

            for i = 1, waves do
                ApplyEffect(unit, nil, start_x + Rx(range * steps, fire_waves[i]), start_y + Ry(range * steps, fire_waves[i]), "fire_stomp_effect", 1, nil)
            end

            steps = steps + 1

            TimerStart(CreateTimer(), 0.22, true, function()
                if steps < 8 then
                    for i = 1, waves do
                        ApplyEffect(unit, nil, start_x + Rx(range * steps, fire_waves[i]), start_y + Ry(range * steps, fire_waves[i]), "fire_stomp_effect", 1, nil)
                    end
                    steps = steps + 1
                else
                    DestroyTimer(GetExpiredTimer())
                end
            end)


    end


    function DiabloApoc(unit)

        for i = 1, 6 do
            if PlayerHero[i] then
                local x, y = GetUnitX(PlayerHero[i]), GetUnitY(PlayerHero[i])
                local sfx = AddSpecialEffect("Effect\\AnnihilationTarget.mdx", x, y)

                    AddSoundVolume("Sounds\\Spells\\Diablo_Apocalypse_Start0"..GetRandomInt(1,4)..".wav", x, y, 120, 1600)
                    BlzSetSpecialEffectScale(sfx, 0.6)
                    DelayAction(3., function()
                        ApplyEffect(unit, nil, x, y, "diablo_apoc_effect", 1, nil)
                        DestroyEffect(sfx)
                    end)

            end
        end

    end


    function PitlordDarknessBarrageCast(caster, point_x, point_y)
        local starting_angle = -25.
        local delay = 0.1

            for i = 1, 3 do
                local angle = GetUnitFacing(caster) + starting_angle
                DelayAction(delay, function() ThrowMissile(caster, nil, "pitlord_darkness_missile", nil, GetUnitX(caster), GetUnitY(caster), 0, 0, angle, true) end)
                starting_angle = starting_angle + 25.
                delay = delay + 0.11
            end

    end


    function PitlordMeteorsCast(caster)
        local timer = CreateTimer()
        local trigger_count = 4


            TimerStart(timer, 0.6, true, function()

                for i = 1, 6 do
                    if PlayerHero[i] and IsUnitInRange(caster, PlayerHero[i], 1400.) then
                        ApplyEffect(caster, PlayerHero[i], GetUnitX(PlayerHero[i]), GetUnitY(PlayerHero[i]), "pitlord_meteor", 1)
                        CreateSpellCircle("Effect\\Spell Marker Red.mdx", GetUnitX(PlayerHero[i]), GetUnitY(PlayerHero[i]), 1., 1., 0.5, function() end)
                    end
                end

                trigger_count = trigger_count - 1
                if trigger_count <= 0 then DestroyTimer(timer) end
            end)

    end


    function BaalNovaCast(caster)
        local amount = 14
        local starting_angle = GetRandomReal(0., 360.)
        local step = 360. / amount

            for i = 1, amount do
                ThrowMissile(caster, nil, "baal_nova_missile", nil, GetUnitX(caster), GetUnitY(caster), 0, 0, starting_angle)
                starting_angle = starting_angle + step
            end


    end


    function InitSpiderQueenData()

        InitMyAI()

    end

    --[[
    - паук
        - плевок ядом по прямой
        - паутина, обездвиживание
        - ловушка паутины
        - укус
        - выводок, призыв
    - бандит
        - чардж, стан
        - боевой кураж, стаки, скорость атаки
        - финт, уменьшение атаки противника
        -
    - арахнид
        - клац, стан
        - волна яда
        - чардж с отталкиванием

    ]]

end

