---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by Stasik.
--- DateTime: 15.01.2020 16:52
---
do

    local MAX_RANGE_XP_LOSS = 1700.
    local MIN_XP_LOSS_RATE = 0.35



    ---@param amount integer
    ---@param x real
    ---@param y real
    function GiveExpForKill(amount, x, y)
        for i = 1, 6 do
            if PlayerHero[i] ~= nil and GetUnitState(PlayerHero[i], UNIT_STATE_LIFE) > 0.45 then
                local xp_rate = 1.
                local distance = DistanceBetweenUnitXY(PlayerHero[i], x, y)

                    if distance > MAX_RANGE_XP_LOSS then
                        xp_rate = MAX_RANGE_XP_LOSS / distance
                    end

                if xp_rate < MIN_XP_LOSS_RATE then xp_rate = MIN_XP_LOSS_RATE end
                AddHeroXP(PlayerHero[i], math.ceil(amount * xp_rate), false)
            end
        end
    end


    ---@param amount integer
    function GiveExp(amount)
        for i = 1, 6 do
            if PlayerHero[i] ~= nil and GetUnitState(PlayerHero[i], UNIT_STATE_LIFE) > 0.45 then
                AddHeroXP(PlayerHero[i], amount, false)
            end
        end
    end



    function CreateHeroSelections()

        local DeathTrigger = CreateTrigger()
        local LvlupTrigger = CreateTrigger()
        local trg = CreateTrigger()
        local barbarian_region = CreateRegion()
        RegionAddRect(barbarian_region, gg_rct_barbarian_select)

        local sorc_region = CreateRegion()
        RegionAddRect(sorc_region, gg_rct_sorceress_select)

        TriggerRegisterEnterRegionSimple(trg, barbarian_region)
        TriggerRegisterEnterRegionSimple(trg, sorc_region)

        TriggerAddAction(trg, function ()
            local region = GetTriggeringRegion()
            local id
            local player_id = GetPlayerId(GetOwningPlayer(GetTriggerUnit()))
            local starting_items = {}
            local starting_skills = {}


                if region == barbarian_region then
                    id = FourCC("HBRB")
                    starting_items[1] = CreateCustomItem("I011", 0., 0.)
                    starting_items[2] = CreateCustomItem("I00X", 0., 0.)
                    starting_items[3] = CreateCustomItem("I010", 0., 0.)
                    starting_items[4] = CreateCustomItem("I00Z", 0., 0.)
                    starting_items[5] = CreateCustomItem("I00Y", 0., 0.)
                    starting_skills[1] = 'A007'
                    starting_skills[2] = 'A00C'
                    starting_skills[3] = 'A00Z'
                else
                    id = FourCC("HSRC")
                    starting_items[1] = CreateCustomItem("I012", 0., 0.)
                    starting_items[2] = CreateCustomItem("I00X", 0., 0.)
                    starting_items[3] = CreateCustomItem("I010", 0., 0.)
                    starting_items[4] = CreateCustomItem("I00Z", 0., 0.)
                    starting_items[5] = CreateCustomItem("I00Y", 0., 0.)
                    starting_skills[1] = 'A003'
                    starting_skills[2] = 'A00J'
                    starting_skills[3] = 'A00D'

                    starting_skills[4] = 'A005'
                    starting_skills[5] = 'A00L'
                    starting_skills[6] = 'A001'
                    starting_skills[7] = 'A00K'
                    starting_skills[8] = 'A00M'
                    starting_skills[9] = 'A019'
                    starting_skills[10] = 'A00F'
                    starting_skills[11] = 'A00I'
                end

                local hero = CreateUnit(Player(player_id), id, GetRectCenterX(gg_rct_starting_location) , GetRectCenterY(gg_rct_starting_location), 270.)
                RemoveUnit(GetTriggerUnit())
                --SelectUnit(hero, true)
                --SelectUnitAddForPlayer(hero, Player(player_id))

                SetCameraBoundsToRectForPlayerBJ(Player(player_id), bj_mapInitialCameraBounds)


                local player_number = player_id
                TimerStart(CreateTimer(), 0.05, true, function()
                    if GetLocalPlayer() == Player(player_number) then
                        if not IsUnitSelected(hero, Player(player_number)) then
                             ClearSelection()
                            SelectUnit(hero, true)
                        end
                    end
                end)

                TimerStart(CreateTimer(), 0.1, false, function()
                    player_id = player_id + 1
                    PlayerHero[player_id] = hero

                    TriggerRegisterDeathEvent(DeathTrigger, hero)
                    TriggerRegisterUnitEvent(LvlupTrigger, hero, EVENT_UNIT_HERO_LEVEL)


                    DrawStatsPanelInterface(player_id)
                    DrawInventoryFrames(player_id, hero)
                    DrawSkillPanel(player_id)
                    DrawShopFrames(player_id)
                    AddToPanel(hero, player_id)
                    AddPointsToPlayer(player_id, 5)
                    DrawQuartermeisterFrames(player_id)
                    LockCameraForPlayer(player_id)
                    --CreateGUILayoutForPlayer(player_id, hero)
                    --TODO redo this garbo ^


                    for i = 1, #starting_items do
                        EquipItem(hero, starting_items[i], true)
                        SetItemVisible(starting_items[i], false)
                        UpdateEquipPointsWindow(player_id)
                    end


                    for i = 1, #starting_skills do
                        UnitAddMyAbility(hero, starting_skills[i])
                    end

                    if GetLocalPlayer() == Player(player_id - 1) then
                        BlzFrameSetVisible(CharButton, true)
                        BlzFrameSetVisible(InventoryTriggerButton, true)
                        BlzFrameSetVisible(SkillPanelButton, true)
                        PanCameraToTimed(GetUnitX(hero), GetUnitY(hero), 0.)
                    end


                    DestroyTimer(GetExpiredTimer())
                end)

        end)


        TriggerAddAction(LvlupTrigger, function()
            AddPointsToPlayer(GetPlayerId(GetOwningPlayer(GetTriggerUnit())) + 1, 3)
        end)

        TriggerAddAction(DeathTrigger, function ()
            local hero = GetTriggerUnit()
            local player = GetOwningPlayer(hero)

            DisplayTextToPlayer(player, 0.,0., "Ваш герой возродится через ".. R2S(7. + (Current_Wave / 4.)) .. " сек. на кладбище.")
            ResetUnitSpellCast(hero)
            ToggleInventory(player, false)

                TimerStart(CreateTimer(), 7. + (Current_Wave / 4.), false, function()
                    ReviveHero(hero, GetRectCenterX(gg_rct_cemetary), GetRectCenterY(gg_rct_cemetary), true)
                    SetUnitTimeScale(hero, 1.)
                    SetUnitAnimationByIndex(hero, 0)
                    IssueImmediateOrderById(hero, order_stop)
                    SetUnitState(hero, UNIT_STATE_LIFE, GetUnitState(hero, UNIT_STATE_MAX_LIFE) * 0.5)
                    SetUnitState(hero, UNIT_STATE_MANA, GetUnitState(hero, UNIT_STATE_MAX_MANA) * 0.5)
                    DestroyTimer(GetExpiredTimer())
                end)

        end)

        RegisterTestCommand("ded", function()
            KillUnit(PlayerHero[1])
        end)


    end

end